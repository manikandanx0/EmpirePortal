{% extends "base.html" %}

{% block title %}
{{ zone.title }} â€“ Zone | ðŸ‘‘ Tech Empire Quest
{% endblock %}

{% block content %}
<section class="max-w-5xl mx-auto min-h-[70vh] space-y-8 relative">

  <!-- MESSAGES -->
  {% if messages %}
    <div class="fixed top-20 right-4 z-50 space-y-2 max-w-md">
      {% for message in messages %}
        <div class="panel px-5 py-3 {% if message.tags == 'error' %}border-[var(--neon-pink)]{% else %}border-[var(--neon-cyan)]{% endif %} mono text-sm">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- ZONE TIMER (TOP LEFT HUD) -->
  <div
    id="zone-timer"
    role="status"
    aria-live="polite"
    aria-atomic="true"
    class="
      fixed top-4  z-40
      panel
      mono
      px-4 py-2.5
      text-sm
      tracking-widest
      select-none
      w-[max-content]
    "
  >
    Time spent: 0:00
  </div>

  <!-- ZONE HEADER -->
  <div class="panel card hud animate-fade-in-up">
    <div class="flex flex-wrap items-center justify-between gap-4">
      <div class="flex items-center gap-4">
        <div
          class="w-14 h-14 rounded-xl bg-gradient-to-br from-[var(--neon-cyan)]/20 to-[var(--neon-purple)]/20 border border-[var(--neon-cyan)]/30 flex items-center justify-center">
          <span class="mono text-xl font-bold text-[var(--neon-cyan)]">Z{{ zone.id }}</span>
        </div>
        <div>
          <h2 id="zone-title" class="text-xl md:text-2xl tracking-widest text-[var(--neon-cyan)] font-semibold">
            {{ zone.title }}
          </h2>
          <p class="mono text-sm text-[var(--text-muted)] tracking-wider mt-1">
            <span class="text-[var(--text-main)]">{{ player.name }}</span>
            <span class="opacity-60 ml-2">// {{ role }}</span>
          </p>
        </div>
      </div>

      <div class="status-indicator status-active">
        IN PROGRESS
      </div>
    </div>
  </div>

  <!-- ZONE CONTENT CARD -->
  <div role="region" aria-labelledby="zone-title"
    class="panel card hud prose prose-invert max-w-none animate-fade-in-up stagger-1">
    <!-- Content Header -->
    <div class="flex items-center gap-2 mb-6 pb-4 border-b border-white/10">
      <svg class="w-5 h-5 text-[var(--neon-purple)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
      </svg>
      <span class="mono text-sm tracking-widest text-[var(--neon-purple)]">MISSION BRIEFING</span>
    </div>

    <!-- Zone Content -->
    {% if content %}
    <div class="zone-content">
      {{ content|safe }}
    </div>
    {% else %}
    <div class="text-center py-12">
      <p class="mono text-sm text-[var(--text-muted)]">// No content available for this zone</p>
    </div>
    {% endif %}
  </div>

  <!-- SUBMIT PANEL -->
  <form
    id="submit-zone-form"
    method="post"
    action="{% url 'submit_zone' zone.id %}"
    class="panel card hud flex flex-col md:flex-row items-center justify-between gap-6 animate-fade-in-up stagger-2"
  >
    {% csrf_token %}
    <input type="hidden" name="exit_code" id="exit-code-input" value="">

    <div class="flex items-center gap-4">
      <div
        class="w-12 h-12 rounded-xl bg-[var(--success)]/10 border border-[var(--success)]/30 flex items-center justify-center shrink-0">
        <svg class="w-6 h-6 text-[var(--success)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      </div>
      <div>
        <p class="mono text-xs text-[var(--text-muted)] tracking-widest uppercase">Ready to Submit?</p>
        <p class="mono text-sm text-[var(--text-main)] mt-1">Complete your mission</p>
      </div>
    </div>

    <button type="button" id="submit-btn" class="btn mono group">
      <svg class="w-5 h-5 transition-transform group-hover:scale-110" fill="none" stroke="currentColor"
        viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      Submit Zone
    </button>
  </form>


  <!-- Back to Zones Link -->
  <div class="text-center pt-2 animate-fade-in" style="animation-delay: 0.5s;">
    <a href="{% url 'zones' %}"
      class="mono text-sm tracking-widest text-[var(--text-muted)] hover:text-[var(--neon-cyan)] inline-flex items-center gap-2 group transition-colors">
      <svg class="w-4 h-4 transition-transform group-hover:-translate-x-1" fill="none" stroke="currentColor"
        viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      Back to Zones
    </a>
  </div>
  <div
    id="exit-code-modal"
    class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center"
  >
    <div class="panel card hud max-w-md w-full mx-4 space-y-4">
      <h3 class="text-xl tracking-widest text-[var(--neon-cyan)]">Enter Exit Code</h3>
      <p class="mono text-sm text-[var(--text-muted)]">
        You must enter the correct exit code to complete this zone.
      </p>
      <input
        type="text"
        id="exit-code-field"
        class="w-full bg-[var(--bg-card)] border border-[var(--neon-cyan)] rounded px-4 py-2 mono text-[var(--text-main)] focus:outline-none focus:border-[var(--neon-pink)]"
        placeholder="Enter exit code..."
      >
      <p id="exit-code-error" class="text-[var(--neon-pink)] text-sm mono hidden">
        Incorrect exit code. Try again.
      </p>
      <div class="flex gap-3 justify-end">
        <button type="button" id="cancel-btn" class="btn mono bg-[var(--bg-panel)]">
          Cancel
        </button>
        <button type="button" id="verify-exit-btn" class="btn mono">
          Verify & Submit
        </button>
      </div>
    </div>
  </div>

</section>

<script>
  (() => {
    // ZONE TIMER (isolated scope)
    const zoneTimerEl = document.getElementById("zone-timer");
    if (!zoneTimerEl) return;

    const zoneStartTime = new Date("{{ attempt.entry_time|date:'c' }}").getTime();

    function updateZoneTimer() {
      const now = Date.now();
      const diff = Math.floor((now - zoneStartTime) / 1000);

      const mins = Math.floor(diff / 60);
      const secs = diff % 60;

      zoneTimerEl.textContent = "Time spent: " + mins + ":" + String(secs).padStart(2, "0");

      // Optional urgency styling
      if (diff > 300) {
        zoneTimerEl.classList.add("border-[var(--neon-pink)]");
      }
    }

    updateZoneTimer();
    setInterval(updateZoneTimer, 1000);
  })();

  (() => {
    // Make all links in zone content open in new tab
    const contentLinks = document.querySelectorAll('.prose a');
    contentLinks.forEach(link => {
      let href = link.getAttribute('href');
      
      // If href doesn't start with http://, https://, or other protocols, add https://
      if (href && !href.match(/^(https?:\/\/|mailto:|tel:|ftp:)/i)) {
        link.setAttribute('href', 'https://' + href);
      }
      
      link.setAttribute('target', '_blank');
      link.setAttribute('rel', 'noopener noreferrer');
    });
  })();

  (() => {
    // EXIT CODE MODAL LOGIC
    const modal = document.getElementById('exit-code-modal');
    const submitBtn = document.getElementById('submit-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const verifyBtn = document.getElementById('verify-exit-btn');
    const exitCodeField = document.getElementById('exit-code-field');
    const exitCodeInput = document.getElementById('exit-code-input');
    const exitCodeError = document.getElementById('exit-code-error');
    const form = document.getElementById('submit-zone-form');

    if (!modal || !submitBtn || !cancelBtn || !verifyBtn || !exitCodeField) return;

    // Show modal when submit button clicked
    submitBtn.addEventListener('click', (e) => {
      e.preventDefault();
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      exitCodeField.value = '';
      exitCodeError.classList.add('hidden');
      exitCodeField.focus();
    });

    // Hide modal on cancel
    cancelBtn.addEventListener('click', () => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    });

    // Handle Enter key in exit code field
    exitCodeField.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        verifyBtn.click();
      }
    });

    // Verify exit code and submit form
    verifyBtn.addEventListener('click', () => {
      const enteredCode = exitCodeField.value.trim();
      
      if (!enteredCode) {
        exitCodeError.textContent = 'Please enter an exit code.';
        exitCodeError.classList.remove('hidden');
        return;
      }

      // Set the exit code value and submit the form
      exitCodeInput.value = enteredCode;
      form.submit();
    });

    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.classList.contains('flex')) {
        cancelBtn.click();
      }
    });
  })();
</script>

{% endblock %}