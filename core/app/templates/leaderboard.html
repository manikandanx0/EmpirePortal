{% extends "base.html" %}

{% block title %}Rankings | üëë Tech Empire Quest{% endblock %}

{% block content %}
<section class="max-w-5xl mx-auto space-y-8 md:space-y-10">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <!-- Score Timeline Graph Panel -->
  <div class="panel card hud animate-fade-in-up" style="padding: 1.5rem 1.75rem 1.25rem;">
    <div style="display:flex; align-items:center; gap:0.75rem; margin-bottom:1rem;">
      <div style="
      width:40px; height:40px; border-radius:12px;
      background: linear-gradient(135deg, rgba(100,243,255,0.15), rgba(139,124,255,0.15));
      border: 1px solid rgba(100,243,255,0.3);
      display:flex; align-items:center; justify-content:center;
      font-size:1.25rem;
    ">üìà</div>
      <div>
        <h3 class="mono" style="
        font-size:0.85rem; letter-spacing:0.15em; margin:0;
        background: linear-gradient(90deg, var(--neon-cyan), var(--neon-purple));
        -webkit-background-clip: text; background-clip: text; color: transparent;
      ">// SCORE TIMELINE</h3>
        <p class="mono" style="font-size:0.65rem; color:var(--text-muted); letter-spacing:0.1em; margin:0;">
          REAL-TIME CTF PROGRESS
        </p>
      </div>
    </div>
    <div style="height: 350px; position: relative;">
      <canvas id="timelineChart"></canvas>
    </div>
  </div>
  <!-- Header -->
  <div class="text-center animate-fade-in-up">
    <div
      class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-[var(--neon-gold)]/20 to-[var(--neon-purple)]/20 border border-[var(--neon-gold)]/30 mb-4">
      <span class="text-3xl">üèÜ</span>
    </div>
    <h2 class="mono text-xl md:text-2xl tracking-widest gradient-text font-bold">
      // GLOBAL RANKINGS
    </h2>
    <p class="mono text-sm text-[var(--text-muted)] tracking-wider mt-2">
      // Sorted by score (high) ‚Üí time (low)
    </p>
  </div>

  <!-- Leaderboard Panel -->
  <div class="panel card hud overflow-hidden animate-fade-in-up stagger-1">

    <!-- Desktop Table View -->
    <div class="hidden md:block overflow-x-auto">
      <table role="table" aria-describedby="leaderboard-caption" class="w-full border-collapse">
        <caption id="leaderboard-caption" class="sr-only">
          Global rankings table showing team, score, and total time
        </caption>

<thead>
  <tr class="border-b border-white/10">
    <th scope="col" class="text-left py-4 px-6 mono text-xs tracking-widest text-[var(--text-muted)]">
      RANK
    </th>
    <th scope="col" class="text-left py-4 px-6 mono text-xs tracking-widest text-[var(--text-muted)]">
      SQUAD
    </th>
    <th scope="col" class="text-right py-4 px-6 mono text-xs tracking-widest text-[var(--text-muted)]">
      SCORE
    </th>
    <th scope="col" class="text-right py-4 px-6 mono text-xs tracking-widest text-[var(--text-muted)]">
      CREDIT
    </th>
    <th scope="col" class="text-right py-4 px-6 mono text-xs tracking-widest text-[var(--text-muted)]">
      TIME
    </th>
  </tr>
</thead>


        <tbody id="leaderboard-body">
          {% for item in leaderboard %}
          <tr class="border-b border-white/5 hover:bg-[var(--neon-cyan)]/5 transition-all group animate-fade-in-up">

            <!-- Rank -->
            <td role="cell" class="py-4 px-6">
              {% if forloop.counter == 1 %}
              <div class="rank-badge rank-1">
                <span class="text-lg mr-1">ü•á</span>
                <span class="font-bold">#1</span>
              </div>
              {% elif forloop.counter == 2 %}
              <div class="rank-badge rank-2">
                <span class="text-lg mr-1">ü•à</span>
                <span class="font-bold">#2</span>
              </div>
              {% elif forloop.counter == 3 %}
              <div class="rank-badge rank-3">
                <span class="text-lg mr-1">ü•â</span>
                <span class="font-bold">#3</span>
              </div>
              {% else %}
              <span class="mono text-[var(--text-muted)] font-medium pl-2">#{{ forloop.counter }}</span>
              {% endif %}
            </td>

            <!-- Team -->
            <td role="cell" class="py-4 px-6">
              <div class="flex items-center gap-3">
                <div
                  class="w-10 h-10 rounded-lg bg-gradient-to-br from-[var(--neon-purple)]/20 to-[var(--neon-cyan)]/20 border border-white/10 flex items-center justify-center mono text-sm font-bold text-[var(--neon-purple)] group-hover:scale-110 transition-transform">
                  {{ item.score.team.name|slice:":2"|upper }}
                </div>
                <span
                  class="tracking-wider text-[var(--text-main)] font-medium group-hover:text-[var(--neon-cyan)] transition-colors">
                  {{ item.score.team.name }}
                </span>
              </div>
            </td>

            <!-- Score -->
            <td role="cell" class="py-4 px-6 text-right">
              <span class="score-display" aria-label="team score">
                {{ item.score.total }}
              </span>
            </td>
            <!-- Credit -->
            <td role="cell" class="py-4 px-6 text-right">
              <span class="mono font-semibold text-[var(--neon-gold)] tracking-wider"
                    aria-label="team credit">
                {{ item.score.credit }}
              </span>
            </td>
            <!-- Time -->
            <td role="cell" class="py-4 px-6 text-right">
              <span class="mono tracking-wider text-[var(--neon-purple)]" aria-label="total time">
                {{ item.total_time_display }}
              </span>
            </td>

          </tr>
          {% empty %}
          <tr>
            <td colspan="4" class="py-12 text-center">
              <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-[var(--text-muted)]/10 mb-4">
                <svg class="w-8 h-8 text-[var(--text-muted)]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
              </div>
              <p class="mono text-sm text-[var(--text-muted)]">
                // No rankings data available yet
              </p>
            </td>
          </tr>
          {% endfor %}
        </tbody>

      </table>
    </div>

    <!-- Mobile Card View -->
    <div class="md:hidden space-y-3 p-4">
      {% for item in leaderboard %}
      <div
        class="flex items-center justify-between p-4 rounded-xl bg-black/30 border border-white/5 hover:border-[var(--neon-cyan)]/30 transition-all animate-fade-in-up">
        <div class="flex items-center gap-3">
          <!-- Rank Badge -->
          {% if forloop.counter == 1 %}
          <div
            class="w-10 h-10 rounded-lg bg-[var(--neon-gold)]/10 border border-[var(--neon-gold)]/50 flex items-center justify-center">
            <span class="text-lg">ü•á</span>
          </div>
          {% elif forloop.counter == 2 %}
          <div
            class="w-10 h-10 rounded-lg bg-[var(--neon-silver)]/10 border border-[var(--neon-silver)]/50 flex items-center justify-center">
            <span class="text-lg">ü•à</span>
          </div>
          {% elif forloop.counter == 3 %}
          <div
            class="w-10 h-10 rounded-lg bg-[var(--neon-bronze)]/10 border border-[var(--neon-bronze)]/50 flex items-center justify-center">
            <span class="text-lg">ü•â</span>
          </div>
          {% else %}
          <div
            class="w-10 h-10 rounded-lg bg-black/40 border border-white/10 flex items-center justify-center mono text-sm text-[var(--text-muted)]">
            #{{ forloop.counter }}
          </div>
          {% endif %}

          <!-- Team Name -->
          <div>
            <p class="text-sm font-medium text-[var(--text-main)]">{{ item.score.team.name }}</p>
            <p class="mono text-xs text-[var(--text-muted)]">Squad</p>
          </div>
        </div>

        <!-- Score & Time -->
        <div class="text-right">
          <p class="mono text-lg font-bold text-[var(--neon-cyan)]">{{ item.score.total }}</p>
          <p class="mono text-xs text-[var(--neon-purple)]">{{ item.total_time_display }}</p>
        </div>
      </div>
      {% empty %}
      <div class="text-center py-8">
        <p class="mono text-sm text-[var(--text-muted)]">// No data available</p>
      </div>
      {% endfor %}
    </div>

  </div>

  <!-- Stats Summary -->
  {% if leaderboard %}
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 animate-fade-in-up stagger-2">
    <div class="panel px-4 py-4 text-center">
      <p class="mono text-xs text-[var(--text-muted)] tracking-widest mb-1">TOTAL TEAMS</p>
      <p class="mono text-2xl font-bold text-[var(--neon-cyan)]">{{ leaderboard|length }}</p>
    </div>
    <div class="panel px-4 py-4 text-center">
      <p class="mono text-xs text-[var(--text-muted)] tracking-widest mb-1">TOP SCORE</p>
      <p class="mono text-2xl font-bold text-[var(--neon-gold)]">
        {% for top in leaderboard|slice:":1" %}{{ top.score.total }}{% empty %}‚Äî{% endfor %}
      </p>
    </div>
    <div class="panel px-4 py-4 text-center">
      <p class="mono text-xs text-[var(--text-muted)] tracking-widest mb-1">COMPETITION</p>
      <p class="mono text-2xl font-bold text-[var(--neon-purple)]">üî•</p>
    </div>
    <div class="panel px-4 py-4 text-center">
      <p class="mono text-xs text-[var(--text-muted)] tracking-widest mb-1">STATUS</p>
      <p class="mono text-sm font-bold text-[var(--success)]">LIVE</p>
    </div>
  </div>
  {% endif %}

  <!-- Footer Nav -->
  <div class="text-center pt-4 animate-fade-in" style="animation-delay: 0.5s;">
    <a href="{% url 'index' %}"
      class="mono text-sm tracking-widest text-[var(--neon-cyan)] hover:underline inline-flex items-center gap-2 group">
      <svg class="w-4 h-4 transition-transform group-hover:-translate-x-1" fill="none" stroke="currentColor"
        viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      Return to Dashboard
    </a>
  </div>

</section>

<script>
  const graphData = {{ graph_data| safe }};

  // Neon color palette matching the site theme
  const neonColors = [
    { border: '#64f3ff', bg: 'rgba(100, 243, 255, 0.08)' },   // Cyan
    { border: '#8b7cff', bg: 'rgba(139, 124, 255, 0.08)' },   // Purple
    { border: '#ff5cf4', bg: 'rgba(255, 92, 244, 0.08)' },    // Pink
    { border: '#ffd700', bg: 'rgba(255, 215, 0, 0.08)' },     // Gold
    { border: '#00ff88', bg: 'rgba(0, 255, 136, 0.08)' },     // Green
    { border: '#ff6b6b', bg: 'rgba(255, 107, 107, 0.08)' },   // Red
    { border: '#4ecdc4', bg: 'rgba(78, 205, 196, 0.08)' },    // Teal
    { border: '#ffe66d', bg: 'rgba(255, 230, 109, 0.08)' },   // Yellow
  ];

  const datasets = graphData.map((team, i) => {
    const color = neonColors[i % neonColors.length];
    return {
      label: team.label,
      data: team.data,
      stepped: true,
      fill: true,
      backgroundColor: color.bg,
      borderColor: color.border,
      borderWidth: 2.5,
      pointRadius: 0,
      pointHoverRadius: 6,
      pointHoverBackgroundColor: color.border,
      pointHoverBorderColor: '#0a0f18',
      pointHoverBorderWidth: 2,
      tension: 0,
    };
  });

  new Chart(document.getElementById("timelineChart"), {
    type: "line",
    data: { datasets: datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'nearest',
        intersect: false,
        axis: 'xy',
      },
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            color: '#b8d4f0',
            font: {
              family: "'Kode Mono', monospace",
              size: 11,
              weight: '600',
            },
            padding: 20,
            usePointStyle: true,
            pointStyle: 'rectRounded',
            boxWidth: 12,
            boxHeight: 12,
          },
        },
        tooltip: {
          backgroundColor: 'rgba(10, 15, 24, 0.92)',
          borderColor: 'rgba(100, 243, 255, 0.3)',
          borderWidth: 1,
          titleColor: '#64f3ff',
          bodyColor: '#e5f2ff',
          titleFont: {
            family: "'Kode Mono', monospace",
            size: 12,
            weight: '700',
          },
          bodyFont: {
            family: "'Space Grotesk', sans-serif",
            size: 13,
          },
          padding: { top: 10, bottom: 10, left: 14, right: 14 },
          cornerRadius: 12,
          displayColors: true,
          boxPadding: 6,
          callbacks: {
            title: function (items) {
              if (items.length > 0) {
                const d = new Date(items[0].parsed.x);
                return d.toLocaleString('en-US', {
                  month: 'short', day: 'numeric',
                  hour: '2-digit', minute: '2-digit'
                });
              }
              return '';
            },
            label: function (ctx) {
              return ' ' + ctx.dataset.label + ':  ' + ctx.parsed.y + ' pts';
            }
          }
        },
      },
      scales: {
        x: {
          type: "time",
          time: { unit: "minute" },
          grid: {
            color: 'rgba(120, 180, 255, 0.06)',
            lineWidth: 1,
          },
          border: {
            color: 'rgba(120, 180, 255, 0.15)',
          },
          ticks: {
            color: '#8aa4c0',
            font: {
              family: "'Kode Mono', monospace",
              size: 10,
            },
            maxRotation: 0,
          },
        },
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(120, 180, 255, 0.06)',
            lineWidth: 1,
          },
          border: {
            color: 'rgba(120, 180, 255, 0.15)',
          },
          ticks: {
            color: '#8aa4c0',
            font: {
              family: "'Kode Mono', monospace",
              size: 10,
            },
            padding: 8,
          },
          title: {
            display: true,
            text: "SCORE",
            color: '#64f3ff',
            font: {
              family: "'Kode Mono', monospace",
              size: 11,
              weight: '700',
            },
            padding: { bottom: 8 },
          },
        },
      },
    },
  });

  
async function fetchLeaderboard() {
    try {
        const response = await fetch("{% url 'leaderboard_data_api' %}");
        const data = await response.json();
        const tbody = document.getElementById("leaderboard-body");

        tbody.innerHTML = "";

        data.leaderboard.forEach((team, index) => {

            let rankDisplay = `#${index + 1}`;
            if (index === 0) rankDisplay = "ü•á #1";
            if (index === 1) rankDisplay = "ü•à #2";
            if (index === 2) rankDisplay = "ü•â #3";

            const initials = team.team.slice(0, 2).toUpperCase();

            const row = `
            <tr class="border-b border-white/5 hover:bg-[var(--neon-cyan)]/5 transition-all group">
                <td class="py-4 px-6 mono">${rankDisplay}</td>

                <td class="py-4 px-6">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-lg bg-gradient-to-br from-[var(--neon-purple)]/20 to-[var(--neon-cyan)]/20 border border-white/10 flex items-center justify-center mono text-sm font-bold text-[var(--neon-purple)] group-hover:scale-110 transition-transform">
                            ${initials}
                        </div>
                        <span class="tracking-wider text-[var(--text-main)] font-medium group-hover:text-[var(--neon-cyan)] transition-colors">
                            ${team.team}
                            ${team.is_you ? '<span class="text-[var(--neon-cyan)] mono text-xs ml-1">(you)</span>' : ''}
                        </span>
                    </div>
                </td>

                <td class="py-4 px-6 text-right">${team.total}</td>
                <td class="py-4 px-6 text-right text-[var(--neon-gold)]">${team.credit}</td>
                <td class="py-4 px-6 text-right text-[var(--neon-purple)]">${team.time}</td>
            </tr>
            `;

            tbody.insertAdjacentHTML("beforeend", row);
        });

    } catch (error) {
        console.error("Leaderboard update failed:", error);
    }
}

// initial load
fetchLeaderboard();

// refresh every 3 seconds
setInterval(fetchLeaderboard, 30000);
</script>



{% endblock %}